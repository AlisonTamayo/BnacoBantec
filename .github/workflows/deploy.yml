name: Deploy BANTEC to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Debug secrets
        run: |
          echo "SSH_HOST loaded -> ${{ secrets.SSH_HOST != '' }}"
          echo "SSH_USER loaded -> ${{ secrets.SSH_USER != '' }}"
          echo "SSH_PRIVATE_KEY loaded -> ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      - name: Deploy BANTEC via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 45m
          script: |
            echo "üìå Iniciando despliegue BANTEC: $(date)"

            # === 1. VARIABLES Y DIRECTORIOS ===
            PROJECT_DIR="$HOME/BnacoBantec"

            # === 2. ACTUALIZAR REPOSITORIO ===
            if [ ! -d "$PROJECT_DIR" ]; then
              git clone https://github.com/AlisonTamayo/BnacoBantec.git "$PROJECT_DIR"
            fi
            cd "$PROJECT_DIR"
            git fetch origin main
            git reset --hard origin/main
            git config --global --add safe.directory "*"
            chmod +x *.sh

            # === 3. SWAP (Opcional, si no existe) ===
            if [ ! -f /swapfile ]; then
              echo "üìù Creando swap de 2GB..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
            fi

            # === 4. DESPLIEGUE SEGURO AUTOMATIZADO ===
            # Pasamos el dominio y el token de los secrets de GitHub
            DOMAIN="${{ secrets.DUCKDNS_DOMAIN }}.duckdns.org"
            TOKEN="${{ secrets.DUCKDNS_TOKEN }}"
            
            sudo ./deploy-secure.sh "$DOMAIN" "$TOKEN"

            # === 5. LIMPIEZA ===
            sudo docker image prune -f

            echo "üìä Estado Final:"
            sudo docker ps
            echo "‚úÖ Deploy BANTEC completado: $(date)"
